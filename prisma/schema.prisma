generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===============================================
// ENUMS PRD v3
// ===============================================

enum EmojiReacao {
  FOGO      // üî• +2 (Quero muito)
  AMOR      // üòç +1 (Gosto)
  NEUTRO    // üòê 0 (Tanto faz)
  NAO_GOSTO // üëé -1 (N√£o gosto)
  PESSIMO   // üíÄ -2 (P√©ssima ideia)
}

enum CategoriaRumor {
  REFORCO    // Transfer√™ncia entrada
  SAIDA      // Transfer√™ncia sa√≠da
  RENOVACAO  // Renova√ß√£o de contrato
  COMISSAO   // Demiss√£o/contrata√ß√£o de t√©cnico
  ESCALACAO  // Escala√ß√£o de jogo
  LESAO      // Les√£o/recupera√ß√£o
  SELECAO    // Convoca√ß√£o sele√ß√£o
  PREMIO     // Premia√ß√£o individual
  CLUBE      // Decis√£o institucional
  DISCIPLINA // Puni√ß√£o/julgamento
}

enum StatusRumor {
  ABERTO
  CONFIRMADO
  DESMENTIDO
  EXPIRADO
}

model User {
  id          String       @id @default(cuid())
  name        String
  username    String       @unique
  avatar      String?
  team        String?      // Time que o usu√°rio torce
  points      Int          @default(0)
  level       Int          @default(1)
  isPremium   Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  predictions Prediction[] // Legado - ser√° deprecado
  badges      UserBadge[]
  reacoes     Reacao[]     // Novo sistema PRD v3
}

model Badge {
  id          String      @id @default(cuid())
  name        String
  description String
  emoji       String
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id])
  earnedAt  DateTime @default(now())

  @@unique([userId, badgeId])
}

model Rumor {
  id              String         @id @default(cuid())
  playerName      String
  playerImage     String?
  fromTeam        String?
  toTeam          String
  title           String
  description     String?
  contexto        String?        // PRD v3: frase curta explicando o cen√°rio

  // PRD v3: Categorias e status tipados
  categoria       CategoriaRumor @default(REFORCO)
  statusRumor     StatusRumor    @default(ABERTO)

  // Legado - mantido para compatibilidade
  category        String         @default("transferencia")
  status          String         @default("open")

  // PRD v3: Dois eixos separados
  probabilidade   Float          @default(50)  // ALG-001: 0-100, vem das fontes jornal√≠sticas
  probTrend       String         @default("estavel") // subindo, caindo, estavel
  confianca       String         @default("baixa")   // baixa, media, alta
  sentiment       Float          @default(0.5)       // Legado - ser√° calculado por time

  closesAt        DateTime
  resolvedAt      DateTime?
  resolvedOutcome Boolean?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Rela√ß√µes legado
  predictions     Prediction[]   // Legado - ser√° deprecado
  signals         Signal[]
  socialPosts     SocialPost[]

  // Sistema de agrega√ß√£o de not√≠cias
  newsItems    RumorNewsItem[]
  rumorSignals RumorSignal[]
  lastScraped  DateTime?
  signalScore  Float?          @default(0)

  // PRD v3: Novas rela√ß√µes
  reacoes      Reacao[]        // Sistema de emojis por torcida
  fontes       FonteRumor[]    // Fontes jornal√≠sticas
  tweets       TweetRumor[]    // Tweets da hashtag #palpiteiros
}

model Prediction {
  id         String   @id @default(cuid())
  rumorId    String
  rumor      Rumor    @relation(fields: [rumorId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  prediction Boolean
  createdAt  DateTime @default(now())

  @@unique([rumorId, userId])
}

model Influencer {
  id          String   @id @default(cuid())
  name        String
  username    String   @unique
  avatar      String?
  outlet      String
  bio         String?
  trustScore  Float    @default(0.5)
  totalHits   Int      @default(0)
  totalMisses Int      @default(0)
  followers   Int      @default(0)
  twitter     String?
  instagram   String?
  youtube     String?
  tiktok      String?
  promoTitle  String?
  promoUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  signals     Signal[]
}

model Signal {
  id           String     @id @default(cuid())
  rumorId      String
  rumor        Rumor      @relation(fields: [rumorId], references: [id])
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id])
  signal       String
  confidence   Float
  reasoning    String?
  source       String?
  createdAt    DateTime   @default(now())
}

model SocialPost {
  id        String   @id @default(cuid())
  rumorId   String?
  rumor     Rumor?   @relation(fields: [rumorId], references: [id])
  platform  String
  author    String
  username  String
  avatar    String?
  content   String
  mediaUrl  String?
  likes     Int      @default(0)
  comments  Int      @default(0)
  shares    Int      @default(0)
  postedAt  DateTime
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  data      String?
  createdAt DateTime @default(now())
}

// ===============================================
// SISTEMA DE AGREGA√á√ÉO DE NOT√çCIAS
// ===============================================

model NewsItem {
  id           String   @id @default(cuid())
  source       String   // "twitter" | "youtube" | "globo" | "uol"
  sourceId     String   // ID √∫nico na fonte (tweet ID, video ID, URL)
  sourceUrl    String   // Link original
  authorName   String?  // Nome do autor/canal
  authorHandle String?  // @handle no Twitter, channel ID no YouTube
  authorAvatar String?  // URL do avatar
  content      String   // Texto do tweet/t√≠tulo do v√≠deo/headline
  summary      String?  // Resumo extra√≠do (primeiros 280 chars)
  imageUrl     String?  // Thumbnail ou imagem
  publishedAt  DateTime // Data de publica√ß√£o original
  scrapedAt    DateTime @default(now())

  // Relacionamento com rumores
  rumors RumorNewsItem[]

  // Entidades extra√≠das (armazenadas como JSON string para SQLite)
  players String? // JSON array: ["neymar", "paqueta"]
  teams   String? // JSON array: ["flamengo", "santos"]

  // M√©tricas (para Twitter/YouTube)
  likes    Int?
  retweets Int?
  views    Int?

  @@unique([source, sourceId])
  @@index([publishedAt])
  @@index([source])
}

model RumorNewsItem {
  id         String   @id @default(cuid())
  rumorId    String
  newsItemId String
  relevance  Float // 0-1, qu√£o relevante √© pro rumor
  createdAt  DateTime @default(now())

  rumor    Rumor    @relation(fields: [rumorId], references: [id])
  newsItem NewsItem @relation(fields: [newsItemId], references: [id])

  @@unique([rumorId, newsItemId])
}

model RumorSignal {
  id       String   @id @default(cuid())
  rumorId  String
  period   DateTime // Timestamp do per√≠odo (hora cheia)
  source   String // "twitter" | "youtube" | "globo" | "uol" | "all"
  mentions Int // Quantidade de men√ß√µes no per√≠odo
  velocity Float // Taxa de crescimento vs per√≠odo anterior

  rumor Rumor @relation(fields: [rumorId], references: [id])

  @@unique([rumorId, period, source])
  @@index([rumorId, period])
}

// ===============================================
// PRD v3: SISTEMA DE REA√á√ïES (Sentimento da Torcida)
// ===============================================

model Reacao {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id])
  rumorId      String
  rumor        Rumor       @relation(fields: [rumorId], references: [id])
  timeId       String      // Time que o torcedor torce (para separar sentimento por torcida)
  emoji        EmojiReacao
  criadoEm     DateTime    @default(now())
  atualizadoEm DateTime    @updatedAt

  @@unique([userId, rumorId]) // Uma rea√ß√£o por usu√°rio por rumor
  @@index([rumorId, timeId])  // Para queries de sentimento por time
}

// ===============================================
// PRD v3: SISTEMA DE JORNALISTAS E FONTES
// ===============================================

model Jornalista {
  id             String       @id @default(cuid())
  nome           String
  handle         String?      @unique // @twitter handle
  veiculo        String?      // ESPN, GE, UOL, etc
  avatar         String?
  seguidores     Int          @default(0)
  credibilidade  Float        @default(50)  // 0-100, come√ßa por seguidores, refina por acerto
  totalPrevisoes Int          @default(0)
  acertos        Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  fontes         FonteRumor[]
}

model FonteRumor {
  id             String     @id @default(cuid())
  rumorId        String
  rumor          Rumor      @relation(fields: [rumorId], references: [id])
  jornalistaId   String
  jornalista     Jornalista @relation(fields: [jornalistaId], references: [id])
  posicao        String     // confirma, nega, neutro
  intensidade    String     // especula, afirma, crava
  textoOriginal  String
  urlOriginal    String
  dataPublicacao DateTime
  createdAt      DateTime   @default(now())

  @@index([rumorId])
  @@index([jornalistaId])
}

// ===============================================
// PRD v3: TWEETS DA HASHTAG #palpiteiros
// ===============================================

model TweetRumor {
  id        String   @id @default(cuid())
  rumorId   String
  rumor     Rumor    @relation(fields: [rumorId], references: [id])
  tweetId   String   @unique // ID do tweet no X
  autor     String   // Nome do autor
  handle    String   // @handle
  avatar    String?
  texto     String
  likes     Int      @default(0)
  retweets  Int      @default(0)
  criadoEm  DateTime // Data do tweet
  aprovado  Boolean  @default(false) // Passou no filtro de seguran√ßa
  createdAt DateTime @default(now())

  @@index([rumorId])
}
